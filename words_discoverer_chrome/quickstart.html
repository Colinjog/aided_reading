<!DOCTYPE html>
<html>
  <head>
    <title>Drive API Quickstart</title>
    <meta charset='utf-8' />
  </head>
  <body>
    <p>Drive API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize-button" style="display: none;">Authorize</button>
    <button id="signout-button" style="display: none;">Sign Out</button>

    <pre id="content"></pre>

    <script type="text/javascript">
      // Client ID and API key from the Developer Console

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      //var SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.file';
      var SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.file';

      var authorizeButton = document.getElementById('authorize-button');
      var signoutButton = document.getElementById('signout-button');


      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          console.log("client inited!");
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          test_sync();
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }


      function simple_success(drive_obj_id) {
          console.log('Object exists! Object id: ' + drive_obj_id);
      }


      function simple_failure(error_msg) {
          console.error('Unable to ensure wd dir. Error: ' + error_msg);
      }


      function create_new_dir(dir_name, fail_cb, success_cb) {
          var body= {"name": dir_name, "mimeType": "application/vnd.google-apps.folder"};
          var req_params = {'path': 'https://www.googleapis.com/drive/v3/files/', 'method': 'POST', 'body': body};
          gapi.client.request(req_params).then(function(jsonResp, rawResp) {
              console.log(jsonResp);
              if (jsonResp.status == 200) {
                  success_cb(jsonResp.result.id);
              } else {
                  fail_cb('Bad dir create status: ' + jsonResp.status);
              }
          });
      }


      function create_new_file(fname, parent_dir_id, success_cb, fail_cb) {
          var body= {"name": fname, "mimeType": "application/vnd.google-apps.file", "parents": [parent_dir_id]};
          var req_params = {'path': 'https://www.googleapis.com/upload/drive/v3/files?uploadType=media', 'method': 'POST', 'body': body};
          gapi.client.request(req_params).then(function(jsonResp, rawResp) {
              console.log(jsonResp);
              if (jsonResp.status == 200) {
                  success_cb(jsonResp.result.id);
              } else {
                  fail_cb('Bad file create status: ' + jsonResp.status);
              }
          });
      }


      function find_gdrive_id(query, fail_cb, found_cb, not_found_cb) {
          //generic function to find single object id
          var full_query_url = 'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(query);
          gapi.client.request({'path': full_query_url, 'method': 'GET'}).then(function(jsonResp, rawResp) {
              console.log(jsonResp);
              if (jsonResp.status != 200) {
                  fail_cb('Bad status: ' + jsonResp.status + ' for query: ' + query);
                  return;
              }
              if (jsonResp.result.files.length > 1) {
                  fail_cb('More than one object found for query: ' + query);
                  return;
              } else if (jsonResp.result.files.length == 1) {
                  var drive_id = jsonResp.result.files[0].id
                  found_cb(drive_id);
                  return;
              }
              not_found_cb();
          });
      }
    

      //function ensure_wd_dir(success_cb, fail_cb) {
      //    var dir_name = "Words Discoverer Sync";
      //    var dir_query = "name = '" + dir_name + "' and trashed = false";
      //    create_new_dir_wrap = function() {
      //        create_new_dir(dir_name, fail_cb, success_cb);
      //    }
      //    find_gdrive_id(dir_query, fail_cb, success_cb, create_new_dir_wrap); 
      //}


      function do_sync_vocabulary(dir_id, vocab, success_cb, fail_cb) {
          var file_query = "name = '" + vocab.name + ".txt' and trashed = false and '" + dir_id + "' in parents";
          create_new_file_wrap = function() {
              create_new_file(vocab.name, dir_id, success_cb, fail_cb);
          }
          find_gdrive_id(file_query, fail_cb, success_cb, create_new_file_wrap);
      }


      function sync_vocabulary(vocab, success_cb, fail_cb) {
          var dir_name = "Words Discoverer Sync";
          var dir_query = "name = '" + dir_name + "' and trashed = false";
          do_sync_vocabulary_wrap = function(dir_id) {
              do_sync_vocabulary(dir_id, vocab, success_cb, fail_cb);
          }
          create_new_dir_wrap = function() {
              create_new_dir(dir_name, fail_cb, do_sync_vocabulary_wrap);
          }
          find_gdrive_id(dir_query, fail_cb, do_sync_vocabulary_wrap, create_new_dir_wrap); 
      }

      
      function test_sync() {
          var words = {"hello": 1, "world": 1, "industry": 1};
          var added = {};
          var deleted = {};
          //var vocabularies = [{"name": "main", "all": words, "added": added, "deleted": deleted, "first_sync": true}];

          // just use all words for added instead of first_sync flag
          // so, you just need "name", "added" and "deleted" params for sync.
          // on first sync deleted is empty and added is the whole vocabulary
          var vocabulary = {"name": "main", "added": words, "deleted": {}};
          sync_vocabulary(vocabulary, simple_success, simple_failure);
      }


    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
